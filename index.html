<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø­Ø³ÙŠÙ†</title>
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-text: #000000;
            --ios-text-secondary: #8E8E93;
            --ios-separator: #C6C6C8;
            --ios-input-bg: #E9E9EB;
            --ios-danger: #FF3B30;
            --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--tg-theme-secondary-bg-color, var(--ios-bg));
            color: var(--tg-theme-text-color, var(--ios-text));
            margin: 0;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        
        .user-badge {
            background-color: var(--tg-theme-bg-color, rgba(255, 255, 255, 0.8));
            color: var(--tg-theme-hint-color, var(--ios-text-secondary));
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 24px;
            text-align: center;
            display: table;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        h3 {
            font-size: 28px; font-weight: 700; margin: 0 0 20px 0;
            color: var(--tg-theme-text-color, #000); letter-spacing: -0.5px;
            text-align: right; padding-right: 5px;
        }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

        .menu-btn {
            background: var(--tg-theme-bg-color, var(--ios-card));
            padding: 20px; border: none; border-radius: 18px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            color: var(--tg-theme-text-color, var(--ios-text));
            display: flex; flex-direction: column; align-items: flex-start;
            justify-content: space-between; height: 110px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: transform 0.1s; position: relative; overflow: hidden;
        }
        .menu-btn:active { transform: scale(0.96); }
        
        .menu-btn .icon-box {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-bottom: 10px; pointer-events: none;
        }
        .menu-btn span { pointer-events: none; }
        .menu-btn.full-width { grid-column: span 2; flex-direction: row; align-items: center; height: auto; padding: 18px 20px; gap: 15px; }
        .menu-btn.full-width .icon-box { margin-bottom: 0; }

        .btn-contract .icon-box { background: #FFF7D6; color: #FF9500; }
        .btn-receipt .icon-box { background: #E2F9E8; color: #34C759; }
        .btn-bank .icon-box { background: #E1F2FF; color: #007AFF; }
        .btn-expense .icon-box { background: #FFEBEA; color: #FF3B30; }
        .btn-history .icon-box { background: #F2E6FF; color: #AF52DE; }

        .form-section { display: none; width: 100%; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .ios-card-group {
            background: var(--tg-theme-bg-color, var(--ios-card));
            border-radius: 18px; padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 20px;
        }

        .input-group { margin-bottom: 18px; display: none; }
        label { font-weight: 500; font-size: 13px; margin-bottom: 8px; display: block; color: var(--tg-theme-hint-color, var(--ios-text-secondary)); text-transform: uppercase; }
        input, select, textarea {
            width: 100%; padding: 14px 16px; border: none;
            background-color: var(--tg-theme-secondary-bg-color, var(--ios-input-bg));
            border-radius: 12px; box-sizing: border-box;
            color: var(--tg-theme-text-color, var(--ios-text));
            font-size: 17px; font-family: inherit; -webkit-appearance: none;
        }
        input:focus { outline: none; background-color: var(--tg-theme-bg-color, #E1E1E6); }

        .photo-upload-box {
            position: relative; border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, var(--ios-input-bg));
            border: 2px dashed #C7C7CC; text-align: center;
            height: 100px; display: flex; align-items: center; justify-content: center;
        }
        .photo-label { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--ios-text-secondary); font-size: 14px; }

        .submit-btn {
            width: 100%; padding: 16px; margin-top: 10px;
            background-color: var(--tg-theme-button-color, var(--ios-blue));
            color: white; border: none; border-radius: 14px;
            font-size: 17px; font-weight: 600; cursor: pointer;
        }
        .back-btn {
            background: none; border: none; color: var(--tg-theme-button-color, var(--ios-blue));
            margin-bottom: 20px; cursor: pointer; font-size: 17px;
            display: flex; align-items: center; padding: 0; font-weight: 500;
        }

        .history-card {
            background: var(--tg-theme-bg-color, var(--ios-card));
            padding: 16px; margin-bottom: 12px; border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            cursor: pointer; border-left: 4px solid transparent;
        }
        .h-header { display: flex; justify-content: space-between; font-size: 13px; color: var(--ios-text-secondary); }
        .h-title { font-weight: 600; font-size: 17px; color: var(--tg-theme-text-color, #000); }
        .status-badge { background: rgba(52, 199, 89, 0.15); color: #34C759; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }

        /* Custom Alert & Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        
        /* Bottom Sheet for Confirm */
        .bottom-sheet {
            align-items: flex-end; /* Align to bottom */
        }
        .bottom-sheet .modal-content {
            border-radius: 24px 24px 0 0;
            width: 100%; max-width: 450px;
            animation: slideUp 0.3s;
            padding-bottom: 40px;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* iOS Alert Style */
        .ios-alert {
            background-color: rgba(245, 245, 245, 0.95);
            width: 270px; border-radius: 14px;
            text-align: center; overflow: hidden;
            backdrop-filter: blur(20px);
            animation: popIn 0.2s;
        }
        .alert-title { font-weight: 600; font-size: 17px; margin: 20px 0 5px; color: #000; }
        .alert-msg { font-size: 13px; color: #000; margin-bottom: 20px; padding: 0 15px; }
        .alert-btn { 
            border-top: 1px solid rgba(60, 60, 67, 0.29); 
            padding: 12px; color: #007AFF; font-weight: 600; font-size: 17px; 
            cursor: pointer; width: 100%; background: transparent; border-left: none; border-right: none; border-bottom: none;
        }
        
        .modal-content {
            background-color: var(--tg-theme-bg-color, #F2F2F7);
            padding: 24px; color: var(--tg-theme-text-color, #000);
        }
        .summary-list { background: #fff; border-radius: 12px; padding: 0 16px; margin: 20px 0; }
        .summary-item { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #E5E5EA; font-size: 15px; }
        .summary-item:last-child { border-bottom: none; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 25px; }
        .btn-confirm { flex: 1; background: #007AFF; color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 16px; }
        .btn-cancel { flex: 1; background: rgba(142, 142, 147, 0.15); color: #007AFF; border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 16px; }
        .btn-disabled { opacity: 0.6; pointer-events: none; }

        @keyframes popIn { from { transform: scale(1.1); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="user-badge" id="userBadge"></div>
    
    <div id="mainMenu">
        <h3>Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
        <div class="menu-grid">
            <button class="menu-btn btn-contract" onclick="openForm('contract')">
                <div class="icon-box">ğŸ“„</div><span>Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</span>
            </button>
            <button class="menu-btn btn-receipt" onclick="openForm('receipt')">
                <div class="icon-box">ğŸ“¥</div><span>ÙˆØµÙ„ Ù‚Ø¨Ø¶</span>
            </button>
            <button class="menu-btn btn-bank" onclick="openForm('bank')">
                <div class="icon-box">ğŸ¦</div><span>ÙˆØµÙ„ Ù…ØµØ±Ù</span>
            </button>
            <button class="menu-btn btn-expense" onclick="openForm('expense')">
                <div class="icon-box">ğŸ’¸</div><span>Ù…ØµØ§Ø±ÙŠÙ</span>
            </button>
            <button class="menu-btn btn-history full-width" onclick="showHistory()">
                <div class="icon-box">ğŸ•’</div><span>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</span>
            </button>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„ÙÙˆØ±Ù… -->
    <div id="formSection" class="form-section">
        <button class="back-btn" onclick="showMenu()">
            <span style="font-size:20px; margin-left:5px;">â€¹</span> Ø±Ø¬ÙˆØ¹
        </button>
        <h2 id="formTitle" style="margin: 0 0 20px 0; font-size: 28px; font-weight: 700;"></h2>
        <div class="ios-card-group">
            <div class="input-group" id="grp_type">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label><select id="transactionType"></select>
            </div>
            <div class="input-group" id="grp_contractNum">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</label><input type="text" inputmode="numeric" id="contractNum" placeholder="105">
            </div>
            <div class="input-group" id="grp_receiptNum">
                <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</label><input type="text" inputmode="numeric" id="receiptNum">
            </div>
            <div class="input-group" id="grp_houseNum">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¯Ø§Ø±</label><input type="text" id="houseNum" inputmode="decimal">
                <div style="font-size:11px; color:#8E8E93; margin-top:4px;">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ø¹Ø¯Ø© Ø£Ø±Ù‚Ø§Ù…</div>
            </div>
            <div class="input-group" id="grp_name">
                <label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="name">
            </div>
            <div class="input-group" id="grp_contractDetails">
                <label>Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</label><input type="text" inputmode="decimal" id="downPayment" class="amount-field" style="margin-bottom:15px;">
                <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ</label><input type="text" inputmode="decimal" id="totalPrice" class="amount-field">
            </div>
            <div class="input-group" id="grp_amount">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="text" inputmode="decimal" id="amount" class="amount-field">
            </div>
            <div class="input-group" id="grp_reason">
                <label>Ø§Ù„Ø³Ø¨Ø¨</label><textarea id="reason" rows="3"></textarea>
            </div>
            <div class="input-group" id="grp_date" style="display:block;">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                <div class="date-container">
                    <select id="date_day" class="date-select"></select>
                    <select id="date_month" class="date-select"></select>
                    <select id="date_year" class="date-select"></select>
                </div>
            </div>
        </div>
        <div class="input-group" id="grp_photo" style="display:block;">
            <div class="photo-upload-box" onclick="document.getElementById('photo').click()">
                <input type="file" id="photo" accept="image/*" style="opacity: 0; position: absolute; width:100%; height:100%; z-index: 2; cursor: pointer;">
                <div class="photo-label"><span style="font-size: 24px;">ğŸ“·</span><span id="photoText">Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø©</span></div>
            </div>
        </div>
        <button class="submit-btn" onclick="prepareData()" id="btn">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„</button>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø³Ø¬Ù„ -->
    <div id="historySection" class="form-section">
        <button class="back-btn" onclick="showMenu()">
             <span style="font-size:20px; margin-left:5px;">â€¹</span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
        <h3 style="margin-bottom: 10px;">Ø§Ù„Ø³Ø¬Ù„</h3>
        <div id="historyList"></div>
        <button onclick="clearHistory()" style="background:none; border:none; color: #FF3B30; width:100%; margin-top:20px; font-weight: 500;">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø®ØµØµØ© (ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª) -->
<div id="customAlert" class="modal">
    <div class="ios-alert">
        <div class="alert-title">ØªÙ†Ø¨ÙŠÙ‡</div>
        <div class="alert-msg" id="alertMessage">Ø±Ø³Ø§Ù„Ø©</div>
        <button class="alert-btn" onclick="closeCustomAlert()">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
<div id="confirmModal" class="modal bottom-sheet">
    <div class="modal-content">
        <div style="width: 40px; height: 5px; background: #E5E5EA; border-radius: 10px; margin: 0 auto 20px auto;"></div>
        <h3 style="text-align: center; margin: 0; font-size: 22px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
        <div class="summary-list" id="summaryContent"></div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()" id="btnCancel">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn-confirm" onclick="finalSend()" id="btnConfirm">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>
</div>

<script>
    const WEBHOOK_URL = "https://hrh1.app.n8n.cloud/webhook/85baeb02-5fd1-4e87-8249-04956c78a414";
    const BOT_TOKEN = "8587976862:AAE8X1osdW9n_fPqr6N4mY2jDwRstEe_GPc"; 
    const CHAT_ID = "5762584781"; 

    let currentType = '';
    let pendingPayload = null; 
    let pendingCaption = "";
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø£Ù…Ø§Ù†
    let dataEntryUser = "Ù…Ø³ØªØ®Ø¯Ù…";
    let dataEntryChatId = "";
    try {
        const tg = window.Telegram.WebApp;
        tg.expand();
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            dataEntryUser = tg.initDataUnsafe.user.first_name;
            dataEntryChatId = tg.initDataUnsafe.user.id;
        }
    } catch (e) { console.log("Telegram init error", e); }
    
    document.getElementById('userBadge').innerText = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${dataEntryUser}`;

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    function showCustomAlert(msg) {
        document.getElementById('alertMessage').innerText = msg;
        document.getElementById('customAlert').style.display = 'flex';
    }
    window.closeCustomAlert = function() {
        document.getElementById('customAlert').style.display = 'none';
    }

    function initDateSelectors() {
        const dS = document.getElementById('date_day'), mS = document.getElementById('date_month'), yS = document.getElementById('date_year');
        const today = new Date();
        for(let d=1; d<=31; d++) { let o=document.createElement('option'); o.value=d; o.innerText=d; if(d===today.getDate()) o.selected=true; dS.appendChild(o); }
        for(let m=1; m<=12; m++) { let o=document.createElement('option'); o.value=m; o.innerText=m; if(m===today.getMonth()+1) o.selected=true; mS.appendChild(o); }
        for(let y=today.getFullYear(); y<=today.getFullYear()+5; y++) { let o=document.createElement('option'); o.value=y; o.innerText=y; if(y===today.getFullYear()) o.selected=true; yS.appendChild(o); }
    }
    initDateSelectors();

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    function getCleanNumber(val) { return val ? val.replace(/[^\d]/g, '') : ''; }
    function formatWithCommas(val) { const n = getCleanNumber(val); return n ? parseInt(n).toLocaleString('en-US') : ''; }
    
    document.querySelectorAll('.amount-field').forEach(inp => {
        inp.addEventListener('input', (e) => {
            const val = e.target.value;
            e.target.value = formatWithCommas(val);
        });
    });

    // Ø§Ù„ØªÙ†Ù‚Ù„
    window.showMenu = function() {
        document.getElementById('formSection').style.display = 'none';
        document.getElementById('historySection').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
    }

    function hideAllFields() {
        document.querySelectorAll('.input-group').forEach(g => { 
            if(g.id!=='grp_date' && g.id!=='grp_photo') g.style.display='none'; 
        });
        document.getElementById('photo').value = '';
        document.getElementById('photoText').innerText = "Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ±Ø©";
        document.getElementById('photoText').style.color = "#8E8E93";
        document.querySelector('.photo-upload-box').style.borderColor = "#C7C7CC";
    }

    window.openForm = function(type) {
        currentType = type;
        hideAllFields();
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('formSection').style.display = 'block';
        document.querySelectorAll('input:not([type="file"]), textarea').forEach(i => i.value='');
        
        const titleMap = { 'contract': 'Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯', 'receipt': 'ÙˆØµÙ„ Ù‚Ø¨Ø¶', 'bank': 'ÙˆØµÙ„ Ù…ØµØ±Ù', 'expense': 'Ù…ØµØ§Ø±ÙŠÙ' };
        document.getElementById('formTitle').innerText = titleMap[type];

        if(type === 'contract') {
            ['grp_contractNum', 'grp_houseNum', 'grp_name', 'grp_contractDetails'].forEach(id => document.getElementById(id).style.display = 'block');
            document.getElementById('lbl_houseNum').innerText = "Ø±Ù‚Ù… Ø§Ù„Ø¯Ø§Ø± (Ù…Ø·Ù„ÙˆØ¨)";
        } else if(type === 'receipt') {
            ['grp_type', 'grp_receiptNum', 'grp_houseNum', 'grp_amount'].forEach(id => document.getElementById(id).style.display = 'block');
            document.getElementById('transactionType').innerHTML = '<option value="Ù‚Ø³Ø·">Ù‚Ø³Ø·</option><option value="Ø¯ÙØ¹Ø©">Ø¯ÙØ¹Ø©</option>';
            document.getElementById('lbl_receiptNum').innerText = "Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ (Ù…Ø·Ù„ÙˆØ¨)";
        } else if(type === 'bank') {
            ['grp_type', 'grp_receiptNum', 'grp_houseNum', 'grp_amount'].forEach(id => document.getElementById(id).style.display = 'block');
            document.getElementById('transactionType').innerHTML = '<option value="Ù…Ø­Ø§Ù…ÙŠ">Ù…Ø­Ø§Ù…ÙŠ</option><option value="Ø¹Ù…ÙˆÙ„Ø©">Ø¹Ù…ÙˆÙ„Ø©</option><option value="Ù‚Ø±Ø¶">Ù‚Ø±Ø¶</option>';
            document.getElementById('lbl_receiptNum').innerText = "Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)";
        } else if(type === 'expense') {
            ['grp_houseNum', 'grp_name', 'grp_reason', 'grp_amount'].forEach(id => document.getElementById(id).style.display = 'block');
            document.getElementById('lbl_houseNum').innerText = "Ø±Ù‚Ù… Ø§Ù„Ø¯Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)";
        }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ¬Ù‡ÙŠØ²
    window.prepareData = function() {
        const photo = document.getElementById("photo").files[0];
        if(!photo) { showCustomAlert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©!"); return; }

        const date = `${document.getElementById('date_year').value}-${document.getElementById('date_month').value.padStart(2,'0')}-${document.getElementById('date_day').value.padStart(2,'0')}`;
        const name = document.getElementById("name").value.trim();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯
        if(['contract', 'receipt', 'bank'].includes(currentType)) {
            const house = parseFloat(getCleanNumber(document.getElementById('houseNum').value));
            if(house > 1178) { showCustomAlert("âŒ Ø±Ù‚Ù… Ø§Ù„Ø¯Ø§Ø± ØºÙŠØ± ØµØ­ÙŠØ­ (ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­)"); return; }
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        pendingPayload = {
            operation_type: currentType, date: date, name: name, 
            data_entry_user: dataEntryUser, data_entry_chat_id: dataEntryChatId,
            timestamp: new Date().toISOString()
        };

        if(currentType === 'contract') {
            const cNum = document.getElementById('contractNum').value;
            const total = document.getElementById('totalPrice').value;
            if(!cNum || !name || !total) { showCustomAlert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„!"); return; }
            pendingPayload.contract_num = cNum;
            pendingPayload.house_num = document.getElementById('houseNum').value;
            pendingPayload.down_payment = getCleanNumber(document.getElementById('downPayment').value);
            pendingPayload.total_price = getCleanNumber(total);
        } else if(currentType === 'receipt' || currentType === 'bank') {
            const amount = document.getElementById('amount').value;
            if(!amount) { showCustomAlert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ù„Øº!"); return; }
            pendingPayload.sub_type = document.getElementById('transactionType').value;
            pendingPayload.receipt_num = document.getElementById('receiptNum').value || "-";
            pendingPayload.house_num = document.getElementById('houseNum').value;
            pendingPayload.amount = getCleanNumber(amount);
        } else if(currentType === 'expense') {
            const amount = document.getElementById('amount').value;
            const reason = document.getElementById('reason').value;
            if(!amount || !reason) { showCustomAlert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø³Ø¨Ø¨!"); return; }
            pendingPayload.house_num = document.getElementById('houseNum').value || "Ø¹Ø§Ù…";
            pendingPayload.reason = reason;
            pendingPayload.amount = getCleanNumber(amount);
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¨Ø´Ù†
        pendingCaption = buildCaption(pendingPayload);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
        let html = "";
        const labels = { 'contract_num':'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯', 'house_num':'Ø§Ù„Ø¯Ø§Ø±', 'name':'Ø§Ù„Ø§Ø³Ù…', 'amount':'Ø§Ù„Ù…Ø¨Ù„Øº', 'total_price':'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ' };
        for(let k in pendingPayload) {
            if(labels[k]) html += `<div class="summary-item"><span class="s-label">${labels[k]}</span><span class="s-value">${pendingPayload[k]}</span></div>`;
        }
        document.getElementById('summaryContent').innerHTML = html;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function buildCaption(d) {
        let t = "";
        const u = d.data_entry_user ? `\n\nğŸ‘¨â€ğŸ’» *Ø¨ÙˆØ§Ø³Ø·Ø©:* ${d.data_entry_user}` : "";
        if(d.operation_type==='contract') t=`ğŸ“„ *Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯*\nğŸ”¢ Ø¹Ù‚Ø¯: ${d.contract_num}\nğŸ  Ø¯Ø§Ø±: ${d.house_num}\nğŸ‘¤ ${d.name}\nğŸ’° Ù…Ù‚Ø¯Ù…Ø©: ${d.down_payment}\nğŸ’µ ÙƒÙ„ÙŠ: ${d.total_price}`;
        else if(d.operation_type==='receipt') t=`ğŸ“¥ *ÙˆØµÙ„ Ù‚Ø¨Ø¶* (${d.sub_type})\nğŸ”¢ ÙˆØµÙ„: ${d.receipt_num}\nğŸ  Ø¯Ø§Ø±: ${d.house_num}\nğŸ’° Ù…Ø¨Ù„Øº: ${d.amount}`;
        else if(d.operation_type==='bank') t=`ğŸ¦ *ÙˆØµÙ„ Ù…ØµØ±Ù* (${d.sub_type})\nğŸ”¢ ÙˆØµÙ„: ${d.receipt_num}\nğŸ  Ø¯Ø§Ø±: ${d.house_num}\nğŸ’° Ù…Ø¨Ù„Øº: ${d.amount}`;
        else t=`ğŸ’¸ *Ù…ØµØ§Ø±ÙŠÙ*\nğŸ  Ø¯Ø§Ø±: ${d.house_num}\nğŸ‘¤ ${d.name}\nğŸ“ ${d.reason}\nğŸ’° Ù…Ø¨Ù„Øº: ${d.amount}`;
        return t + `\nğŸ“… ${d.date}` + u;
    }

    window.closeModal = function() { document.getElementById('confirmModal').style.display = 'none'; }

    // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    window.finalSend = function() {
        if(!pendingPayload) return;
        const btn = document.getElementById('btnConfirm');
        const btnCancel = document.getElementById('btnCancel');
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
        btn.disabled = true;
        btn.classList.add('btn-disabled');
        btnCancel.style.display = 'none';

        const photo = document.getElementById("photo").files[0];
        
        // 1. Webhook (Data Only)
        const fdWeb = new FormData();
        if(photo) fdWeb.append("photo", photo);
        fdWeb.append("json_data", JSON.stringify(pendingPayload));
        const p1 = fetch(WEBHOOK_URL, {method:'POST', body:fdWeb}).catch(e=>console.log(e));

        // 2. Telegram Direct (Message)
        const fdTg = new FormData();
        fdTg.append("chat_id", CHAT_ID);
        fdTg.append("caption", pendingCaption);
        fdTg.append("parse_mode", "Markdown");
        if(photo) fdTg.append("photo", photo);
        
        const p2 = fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {method:'POST', body:fdTg});

        // 3. User Copy
        let p3 = Promise.resolve();
        if(dataEntryChatId && String(dataEntryChatId) !== String(CHAT_ID)) {
            const fdUser = new FormData();
            fdUser.append("chat_id", dataEntryChatId);
            fdUser.append("caption", "âœ… *ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­*\n\n" + pendingCaption);
            fdUser.append("parse_mode", "Markdown");
            if(photo) fdUser.append("photo", photo);
            p3 = fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {method:'POST', body:fdUser}).catch(e=>{});
        }

        Promise.all([p2, p3]).then(res => {
            if(res[0].ok) {
                saveHistory(pendingPayload);
                closeModal();
                showCustomAlert("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
                showMenu();
            } else {
                throw new Error("Telegram Error");
            }
        }).catch(e => {
            showCustomAlert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");
        }).finally(() => {
            btn.innerText = "ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„";
            btn.disabled = false;
            btn.classList.remove('btn-disabled');
            btnCancel.style.display = 'block';
        });
    }

    // Ø§Ù„Ø³Ø¬Ù„
    function saveHistory(data) {
        let h = JSON.parse(localStorage.getItem('appHistory') || '[]');
        h.unshift({ ...data, ts: new Date().toLocaleDateString('ar-EG') });
        if(h.length>20) h=h.slice(0,20);
        localStorage.setItem('appHistory', JSON.stringify(h));
    }

    window.showHistory = function() {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('historySection').style.display = 'block';
        const list = document.getElementById('historyList');
        const h = JSON.parse(localStorage.getItem('appHistory') || '[]');
        list.innerHTML = h.length ? '' : '<div class="no-history">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</div>';
        
        h.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'history-card';
            div.onclick = () => loadHistory(item);
            let border = item.operation_type === 'contract' ? '#FF9500' : '#34C759';
            div.style.borderLeftColor = border;
            div.innerHTML = `
                <div class="h-header"><span>${item.ts}</span><span class="status-badge">ØªÙ…</span></div>
                <div class="h-title">${item.operation_type === 'contract' ? 'Ø¹Ù‚Ø¯ ' + item.contract_num : 'Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ©'}</div>
                <div class="h-detail">${item.amount || item.total_price || ''}</div>
            `;
            list.appendChild(div);
        });
    }

    function loadHistory(data) {
        showCustomAlert("âš ï¸ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©.");
        openForm(data.operation_type);
        // ØªØ¹Ø¨Ø¦Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙØ±Ø©
        if(data.name) document.getElementById('name').value = data.name;
        if(data.contract_num) document.getElementById('contractNum').value = data.contract_num;
        if(data.house_num) document.getElementById('houseNum').value = data.house_num;
        if(data.amount) document.getElementById('amount').value = formatWithCommas(data.amount);
    }

    window.clearHistory = function() {
        localStorage.removeItem('appHistory');
        showHistory();
    }

    // ØªØ­Ø³ÙŠÙ† Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById('photo').addEventListener('change', function() {
        const txt = document.getElementById('photoText');
        const box = document.querySelector('.photo-upload-box');
        if(this.files[0]) {
            txt.innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: " + this.files[0].name;
            txt.style.color = "#34C759";
            box.style.borderColor = "#34C759";
        }
    });
</script>

</body>
</html>
